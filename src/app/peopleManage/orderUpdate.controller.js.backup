(function() {
    'use strict';

    angular
        .module('suzhou')
        .controller('OrderUpdateController', OrderUpdateController);

    /** @ngInject */
    function OrderUpdateController($scope, $rootScope, $http, $state, $stateParams, Tools, DataService) {
        var newOrder = {
            orderItems: [],
            order: {
                id: '',
                peoplename: '',
                ordername: '',
                ordertime: new Date(),
                orderstatus: 0,
                orderamount: 0,
                itemSize: 0,
            }
        };

        // 将挂载在数据服务上的数据取回，若为空，则请求网络数据，并挂载.
        $scope.data = DataService.fetch($state.current.name);
        if (_.isEmpty($scope.data)) {
            $scope.data = {};
            if ($stateParams.orderid) {
                $scope.data.order = '';//fetchData(id)
            } else {
                $scope.data.order = newOrder;
            }
            DataService.mount($state.current.name, $scope.data);
        }

        function getGoodsInfo() {
            var info = {
                goods: {
                    name: '',
                    goodstype: ''
                },
                page: {
                    pageNo: 1,
                    pageSize: 10000,
                }
            };
            $http.post(Setting.host + 'goods/index', info).success(function(data){
                if (data.goods && !(data.goods instanceof Array)) {
                    data.goods = [data.goods];
                }
                $scope.data.goods = data.goods; //////////

                for (var i = 0; i < data.goods.length; i++) {
                    if (data.goods[i].goodstype != 1 && data.goods[i].goodstype != 2) {
                        continue;
                    }
                    delete data.goods[i].id;
                    delete data.goods[i].createtime;
                    delete data.goods[i].edittime;
                    delete data.goods[i].factoryid;

                    // deal with note
                    if (data.goods[i].note) {
                        data.goods[i].allnotes = [];
                        var notes = data.goods[i].note.split('&');
                        for (var j = 0; j < notes.length; j++) {
                            data.goods[i].allnotes.push({text: notes[j]});
                        }
                        data.goods[i].note = '';
                    }

                    var good = Tools.clone(data.goods[i]);
                    good.ItemDetails = [];
                    if (!good.number) {
                        good.number = 1;
                    }
                    for (var j = 0; j < good.number; j++) {
                        good.ItemDetails.push({});
                    }
                    newOrder.orderItems.push(good);
                }
            }).error(function(data) {

            });
        }
        getGoodsInfo();

        $scope.addGoods = function() {
            $scope.data.order.orderItems.push({goodstype: 2});
        };
        $scope.change = function(good) {
            if (good.name == '') {
                $scope.data.order.orderItems = _.without($scope.data.order.orderItems, good);
                return;
            }
            var goods = $scope.data.goods;
            for (var i = 0; i < goods.length; i++) {
                if ((goods[i].goodstype == 0 || goods[i].goodstype == 2) && goods[i].name == good.name) {
                    good.price = goods[i].price;
                    good.note = goods[i].note;
                    good.unit = goods[i].unit;
                    // good.detailSize = goods[i].detailSize;
                }
            }
        };
        $scope.sum = function(good) {
            var sum = 0;
            for (var i = 0; i < good.ItemDetails.length; i++) {
                if(angular.isNumber(good.ItemDetails[i].detaila) && angular.isNumber(good.ItemDetails[i].detailb)) {
                    sum += good.ItemDetails[i].detaila * good.ItemDetails[i].detailb;
                }
            }
            good.count = sum.toFixed(2) - 0;
        };
        $scope.sum2 = function(good) {
            if(angular.isNumber(good.count) && angular.isNumber(good.price)) {
                good.totalmoney = good.count * good.price;
                good.totalmoney = good.totalmoney.toFixed(2) - 0;
            }
        };
        $scope.sum3 = function(order) {
            var sum = 0;
            for (var i = 0; i < order.orderItems.length; i++) {
                if (angular.isNumber(order.orderItems[i].totalmoney)) {
                    sum += order.orderItems[i].totalmoney;
                }
            }
            order.order.orderamount = sum.toFixed(2) - 0;
        };
        $scope.checkbox = function(good,selected) {
            var notes = [];
            for (var i = 0; i < good.allnotes.length; i++) {
                if (good.allnotes[i].selected) {
                    notes.push(good.allnotes[i].text);
                }
            }
            good.note = notes.join('、');
        };
        $scope.save = function() {
            if ($scope.data.order.order.peoplename == '') {
                Tools.alert({
                    data: {
                        // title: '提示',
                        message: '请输入姓名'
                    }
                });
                return;
            }
            if ($scope.data.order.order.ordername == '') {
                Tools.alert({
                    data: {
                        // title: '提示',
                        message: '请输入产品'
                    }
                });
                return;
            }
            for (var i = 0; i < $scope.data.order.orderItems.length; i++) {
                if ($scope.data.order.orderItems[i].ItemDetails.length) {
                    $scope.data.order.orderItems[i].detailSize = $scope.data.order.orderItems[i].ItemDetails.length;
                }
            };
            $scope.data.order.order.itemSize = $scope.data.order.orderItems.length;
            $http.post(Setting.host + 'order/update', $scope.data.order).success(function(data){
                console.log('OK');
            }).error(function(data) {
                console.log('FAIL');
            });
        };
    }
})();
